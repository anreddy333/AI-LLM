pipeline {
    agent any
    
    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }
        stage('Setup') {
            steps {
                sh '''
                    sudo apt-get update
                    sudo apt-get install -y curl
                    sudo python3 -m venv venv
                    ls
                    sudo ./venv/bin/activate
                    sudo pip install --no-cache-dir -r requirements.txt
                    sudo python -m playwright install --with-deps chromium
                '''
            }
        }
        stage('Test') {
            steps {
                sh '''
                    pytest tests/test_gmail_login.py --junitxml=test-results.xml >> build.log 2>&1 || exit 1
                '''
            }
        }
    }
    post {
        always {
            archiveArtifacts artifacts: 'test-results.xml,build.log', allowEmptyArchive: true
            cleanWs()
        }
        failure {
            script {
                def consoleLog
                try {
                    consoleLog = readFile('build.log') ?: 'No log available'
                    consoleLog += "\nPipeline console log:\n${currentBuild.rawBuild.getLog(1000).join('\n')}"
                    consoleLog = consoleLog.split('\n').findAll {
                        it.contains('ERROR') || it.contains('FAIL') || it.contains('exception') ||
                        it.contains('not found') || it.contains('fatal') || it.contains('timeout') ||
                        it.contains('refused') || it.contains('sudo') || it.contains('cd:')
                    }.join('\n') ?: 'No error details found in logs'
                    if (consoleLog.length() > 5000) {
                        consoleLog = consoleLog.substring(0, 5000) + '\n[Log truncated]'
                    }
                } catch (Exception e) {
                    consoleLog = "Failed to read logs: ${e.message}"
                }

                def llmResponse = 'No response from LLM'
                try {
                    echo "Attempting to contact LLM server..."
                    retry(3) {
                        def response = httpRequest(
                            url: 'http://10.1.148.59:5000/generate',
                            httpMode: 'POST',
                            contentType: 'APPLICATION_JSON',
                            requestBody: groovy.json.JsonOutput.toJson([
                                model: 'codellama',
                                prompt: """
                                You are **BuildGPT**, a CI/CD and QA incident response specialist.
 
                            When given a Jenkins pipeline failure, you will:
                            
                            1. **Locate** the failing **stage/step** (or report ‚ÄúUNKNOWN‚Äù).  
                            2. Summarize the **root cause** in ‚â§2 sentences.  
                            3. Provide **actionable fixes**‚Äîordered, precise, and ready to execute.  
                            4. If a test snippet is provided, **review** it and:
                            - Highlight the faulty line(s)
                            - Suggest how to correct or harden the test  
                            5. Quote up to **5 log lines** as evidence.  
                            6. Offer ‚Äú**Next Steps**‚Äù if the issue persists.
                            
                            ‚ÄºÔ∏è **Reply *exactly* in this Markdown template** (no extra text):
                            
                            **Failure Stage**: <stage-name OR ‚ÄúUNKNOWN‚Äù>  
                            **Root Cause**: <one-sentence summary>
                            
                            **Recommended Fix**:
                            1. <step 1>
                            2. <step 2>
                            3. <step 3>
                            
                            **Key Evidence**:
                            **Test Code Review**${failedTest ? "" : " _(none provided)_"}:

                            
                            
                            <if provided: show faulty lines + correction suggestion>
                            
                            Plain Text
                            **Next Steps if Unresolved**:
                            - <idea 1>
                            - <idea 2>

                            ---

                            **Console Log (truncated)** 
                            ${consoleLog}

                            ${failedTest ? "üîπ **Suspect Test Snippet** üîπ\n```groovy\n${failedTest}\n```" : ""}

                                """
                            ]),
                            validResponseCodes: '200:299',
                            timeout: 180,
                            consoleLogResponseBody: true,
                            customHeaders: [[name: 'Connection', value: 'keep-alive']]
                        )
                        llmResponse = response.content ?: 'Empty response from LLM'
                        echo "Received LLM response: ${llmResponse.take(100)}..."
                    }
                } catch (Exception e) {
                    llmResponse = "Error: Failed to contact LLM server - ${e.message}\n\nLog for manual triage:\n${consoleLog}"
                    echo "LLM error: ${e.message}"
                }

                writeFile file: 'llm-triage-result.txt', text: llmResponse
                sh "ls -la llm-triage-result.txt || echo 'File not found'"
                sh "cat llm-triage-result.txt || echo 'Failed to read file'"
                sh "pwd && ls -la ${WORKSPACE}"
                archiveArtifacts artifacts: 'llm-triage-result.txt', allowEmptyArchive: true
            }
        }
    }
}
